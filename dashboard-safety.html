<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Ultracold Matter Lab - Live Dashboard</title>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-database-compat.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body { font-family: Arial, sans-serif; margin: 20px; }
    #chartContainer { width: 100%; max-width: 900px; margin-bottom: 30px; }
    #serialMonitor {
      width: 100%; max-width: 900px; height: 200px; overflow-y: auto; background: #000; color: #0f0;
      padding: 10px; font-family: monospace; border-radius: 5px;
    }
    .entry { margin-bottom: 4px; }
    .sensor-label { font-weight: bold; }
    .timestamp { font-style: italic; color: #aaa; }
  </style>
</head>
<body>

  <h2>Ultracold Matter Lab - Live Sensor Dashboard</h2>

  <div id="chartContainer">
    <canvas id="sensorChart"></canvas>
  </div>

  <h3>Serial Monitor (Last 20 Entries)</h3>
  <div id="serialMonitor"></div>

  <script>
    // Your Firebase config
    const firebaseConfig = {
      apiKey: "AIzaSyATktR2jpo9ghUY0_MqpZh_KP5jrW-6YZE",
      authDomain: "ultracoldmatterlablive.firebaseapp.com",
      databaseURL: "https://ultracoldmatterlablive-default-rtdb.asia-southeast1.firebasedatabase.app",
      projectId: "ultracoldmatterlablive",
      storageBucket: "ultracoldmatterlablive.firebasestorage.app",
      messagingSenderId: "75894080963",
      appId: "1:75894080963:web:cfa41a9bd08d4f567f6976"
    };

    // Initialize Firebase
    firebase.initializeApp(firebaseConfig);
    const database = firebase.database();

    // Setup Chart.js line chart with 6 sensors, temp & humidity
    const ctx = document.getElementById('sensorChart').getContext('2d');

    const sensorColors = [
      'rgb(255, 99, 132)',    // Sensor 1 - Red
      'rgb(54, 162, 235)',    // Sensor 2 - Blue
      'rgb(255, 206, 86)',    // Sensor 3 - Yellow
      'rgb(75, 192, 192)',    // Sensor 4 - Teal
      'rgb(153, 102, 255)',   // Sensor 5 - Purple
      'rgb(255, 159, 64)'     // Sensor 6 - Orange
    ];

    const chartData = {
      labels: [], // time labels
      datasets: []
    };

    // Create datasets for temperature (solid) and humidity (dashed) for each sensor
    for(let i=0; i<6; i++) {
      chartData.datasets.push({
        label: `Sensor ${i+1} Temp (°C)`,
        data: [],
        borderColor: sensorColors[i],
        backgroundColor: sensorColors[i],
        fill: false,
        tension: 0.1,
        borderWidth: 2,
        spanGaps: true,
      });
      chartData.datasets.push({
        label: `Sensor ${i+1} Hum (%)`,
        data: [],
        borderColor: sensorColors[i],
        backgroundColor: sensorColors[i],
        fill: false,
        borderDash: [5,5],
        borderWidth: 2,
        tension: 0.1,
        spanGaps: true,
        // make humidity lines semi-transparent
        segment: {
          borderColor: ctx => ctx.p0.parsed.y !== null ? sensorColors[i] + '88' : sensorColors[i] + '00'
        }
      });
    }

    const sensorChart = new Chart(ctx, {
      type: 'line',
      data: chartData,
      options: {
        responsive: true,
        interaction: {
          mode: 'nearest',
          intersect: false
        },
        scales: {
          x: {
            type: 'time',
            time: {
              tooltipFormat: 'dd MMM yyyy HH:mm:ss',
              displayFormats: { second: 'HH:mm:ss' }
            },
            title: { display: true, text: 'Time' }
          },
          y: {
            beginAtZero: true,
            title: { display: true, text: 'Value' }
          }
        },
        plugins: {
          legend: { position: 'top' }
        }
      }
    });

    // Keep last 20 serial entries
    const serialMonitor = document.getElementById('serialMonitor');
    const maxSerialEntries = 20;
    let serialEntries = [];

    function addSerialEntry(text) {
      serialEntries.unshift(text);
      if (serialEntries.length > maxSerialEntries) serialEntries.pop();
      serialMonitor.innerHTML = serialEntries.map(e => `<div class="entry">${e}</div>`).join('');
    }

    // Function to parse ISO timestamp and format nicely
    function formatTimestamp(iso) {
      const d = new Date(iso);
      if (isNaN(d)) return iso;
      return d.toLocaleString('en-IN', {
        day: '2-digit', month: 'short', year: 'numeric',
        hour: '2-digit', minute: '2-digit', second: '2-digit',
        hour12: true
      });
    }

    // Listen for live data updates from Firebase RTDB
    function setupFirebaseListeners() {
      for(let sensorNum = 1; sensorNum <= 6; sensorNum++) {
        const sensorPath = `/sensors/sensor${sensorNum}`;
        const sensorRef = database.ref(sensorPath);

        // Listen for new child added under sensor path (timestamp keys)
        sensorRef.limitToLast(1).on('child_added', snapshot => {
          const timestamp = snapshot.key;
          const data = snapshot.val();

          if (!data) return;

          const timeFormatted = formatTimestamp(timestamp);
          const temp = data.temperature;
          const hum = data.humidity;

          // Add data point to chart datasets
          // X axis is time (Date), Y is temp or humidity
          const timeDate = new Date(timestamp);
          if (isNaN(timeDate)) return;

          // Update temperature dataset
          const tempDatasetIndex = (sensorNum - 1) * 2;
          chartData.datasets[tempDatasetIndex].data.push({ x: timeDate, y: temp });

          // Update humidity dataset
          const humDatasetIndex = tempDatasetIndex + 1;
          chartData.datasets[humDatasetIndex].data.push({ x: timeDate, y: hum });

          // Keep datasets to max 50 points for performance
          if (chartData.datasets[tempDatasetIndex].data.length > 50) {
            chartData.datasets[tempDatasetIndex].data.shift();
          }
          if (chartData.datasets[humDatasetIndex].data.length > 50) {
            chartData.datasets[humDatasetIndex].data.shift();
          }

          sensorChart.update('none'); // update chart without animation

          // Update serial monitor
          addSerialEntry(
            `<span class="sensor-label">Sensor ${sensorNum}</span> | ` +
            `Temp: ${temp.toFixed(2)} °C, Hum: ${hum.toFixed(2)} % | ` +
            `<span class="timestamp">${timeFormatted}</span>`
          );
        });
      }
    }

    setupFirebaseListeners();

  </script>
</body>
</html>
