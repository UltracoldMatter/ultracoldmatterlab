<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Live Temperature & Humidity Dashboard (6 Sensors)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <!-- Chart.js CDN -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <!-- Firebase CDN (compat version for static HTML) -->
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
  <style>
    body { font-family: Arial, sans-serif; background: #181a1b; color: #fff; margin: 0; padding: 0; }
    h1 { text-align: center; }
    .sensor-section { width: 95vw; max-width: 900px; margin: 30px auto 30px auto; background: #222; padding: 20px 10px 10px 10px; border-radius: 12px; }
    .sensor-title { font-size: 1.3em; margin-bottom: 10px; }
    .chart-container { margin-bottom: 10px; }
    .serial-monitor { background: #222; padding: 15px; border-radius: 12px; min-height: 80px; font-size: 1.05em; }
    .serial-entry { border-bottom: 1px solid #333; padding: 5px 0; }
    .serial-entry:last-child { border-bottom: none; }
    @media (max-width: 600px) {
      .sensor-section { padding: 5px; }
      .serial-monitor { padding: 5px; }
    }
  </style>
</head>
<body>
  <h1>Live Temperature & Humidity Stream (6 Sensors)</h1>
  <div id="sensors-root"></div>
  <script>
    // --- Firebase Config ---
    const firebaseConfig = {
      apiKey: "AIzaSyATktR2jpo9ghUY0_MqpZh_KP5jrW-6YZE",
      authDomain: "ultracoldmatterlablive.firebaseapp.com",
      databaseURL: "https://ultracoldmatterlablive-default-rtdb.asia-southeast1.firebasedatabase.app",
      projectId: "ultracoldmatterlablive",
      storageBucket: "ultracoldmatterlablive.appspot.com",
      messagingSenderId: "75894080963",
      appId: "1:75894080963:web:cfa41a9bd08d4f567f6976"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    // --- Sensor IDs ---
    const sensorIds = ['sensor1', 'sensor2', 'sensor3', 'sensor4', 'sensor5', 'sensor6'];

    // --- Create UI for each sensor ---
    const root = document.getElementById('sensors-root');
    const chartObjs = {};
    const serialMonitors = {};

    sensorIds.forEach(sensorId => {
      // Create section
      const section = document.createElement('div');
      section.className = "sensor-section";
      section.innerHTML = `
        <div class="sensor-title">Sensor: <b>${sensorId}</b></div>
        <div class="chart-container"><canvas id="chart-${sensorId}"></canvas></div>
        <div class="serial-monitor" id="serial-${sensorId}">
          <strong>Serial Monitor:</strong>
          <div id="serial-entries-${sensorId}"></div>
        </div>
      `;
      root.appendChild(section);

      // Chart.js setup
      const ctx = section.querySelector(`#chart-${sensorId}`).getContext('2d');
      const chartData = {
        labels: [],
        datasets: [
          {
            label: 'Temperature (°C)',
            data: [],
            borderColor: 'rgba(255,99,132,1)',
            backgroundColor: 'rgba(255,99,132,0.1)',
            borderWidth: 3,
            fill: false,
            tension: 0.3,
            pointRadius: 2,
          },
          {
            label: 'Humidity (%)',
            data: [],
            borderColor: 'rgba(255,255,255,0.5)',
            borderDash: [8, 6],
            backgroundColor: 'rgba(255,255,255,0.1)',
            borderWidth: 3,
            fill: false,
            tension: 0.3,
            pointRadius: 2,
          }
        ]
      };
      const chart = new Chart(ctx, {
        type: 'line',
        data: chartData,
        options: {
          responsive: true,
          plugins: {
            legend: { labels: { color: "#fff" } }
          },
          scales: {
            x: { ticks: { color: "#ccc" } },
            y: { ticks: { color: "#ccc" }, beginAtZero: false }
          }
        }
      });
      chartObjs[sensorId] = chart;
      serialMonitors[sensorId] = section.querySelector(`#serial-entries-${sensorId}`);
    });

    // --- Fetch and Stream Data for each sensor ---
    const MAX_SERIAL_ENTRIES = 20;

    sensorIds.forEach(sensorId => {
      const sensorRef = db.ref('sensors/' + sensorId);
      sensorRef.limitToLast(30).on('value', snapshot => {
        const data = snapshot.val();
        const chart = chartObjs[sensorId];
        const serialMonitor = serialMonitors[sensorId];
        if (!data) {
          serialMonitor.innerHTML = '<div class="serial-entry">No data available.</div>';
          chart.data.labels.length = 0;
          chart.data.datasets[0].data.length = 0;
          chart.data.datasets[1].data.length = 0;
          chart.update();
          return;
        }
        // Sort by timestamp key
        const entries = Object.entries(data).sort(([a], [b]) => a.localeCompare(b));
        // Reset chart data
        chart.data.labels.length = 0;
        chart.data.datasets[0].data.length = 0;
        chart.data.datasets[1].data.length = 0;
        let serialBuffer = [];
        entries.forEach(([timestamp, values]) => {
          // Defensive checks for missing or invalid data
          const temp = values && typeof values.temperature === 'number' ? values.temperature : null;
          const hum = values && typeof values.humidity === 'number' ? values.humidity : null;

          // Add to chart (use null for missing data)
          chart.data.labels.push(timestamp.slice(11,19)); // Show only HH:MM:SS
          chart.data.datasets[0].data.push(temp);
          chart.data.datasets[1].data.push(hum);

          // Add to serial buffer
          serialBuffer.push(
            `<div class="serial-entry">${sensorId.replace(/sensor/, "Sensor ")} &rarr; Temp: <b>${temp !== null ? temp.toFixed(2) + ' °C' : 'N/A'}</b>, Hum: <b>${hum !== null ? hum.toFixed(2) + ' %' : 'N/A'}</b> at <span style="color:#aaa">${timestamp}</span></div>`
          );
        });
        // Update chart
        chart.update();
        // Update serial monitor (show last MAX_SERIAL_ENTRIES)
        serialMonitor.innerHTML = serialBuffer.slice(-MAX_SERIAL_ENTRIES).reverse().join('');
      });
    });
  </script>
</body>
</html>
