<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Live Temperature & Humidity Monitor</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <!-- Chart.js CDN -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <!-- Firebase CDN -->
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
  <style>
    body { font-family: Arial, sans-serif; background: #181a1b; color: #fff; margin: 0; padding: 0; }
    h1 { text-align: center; }
    #chart-container { width: 95vw; max-width: 900px; margin: 30px auto 10px auto; background: #222; padding: 20px 10px 10px 10px; border-radius: 12px; }
    #serial-monitor { width: 95vw; max-width: 900px; margin: 0 auto 30px auto; background: #222; padding: 20px; border-radius: 12px; min-height: 120px; font-size: 1.1em; }
    .serial-entry { border-bottom: 1px solid #333; padding: 5px 0; }
    .serial-entry:last-child { border-bottom: none; }
    @media (max-width: 600px) {
      #chart-container, #serial-monitor { padding: 5px; }
    }
  </style>
</head>
<body>
  <h1>Live Temperature & Humidity Stream</h1>
  <div id="chart-container">
    <canvas id="liveChart"></canvas>
  </div>
  <div id="serial-monitor">
    <strong>Serial Monitor:</strong>
    <div id="serial-entries"></div>
  </div>
  <script>
    // --- Firebase Config ---
    const firebaseConfig = {
      apiKey: "AIzaSyATktR2jpo9ghUY0_MqpZh_KP5jrW-6YZE",
      authDomain: "ultracoldmatterlablive.firebaseapp.com",
      databaseURL: "https://ultracoldmatterlablive-default-rtdb.asia-southeast1.firebasedatabase.app",
      projectId: "ultracoldmatterlablive",
      storageBucket: "ultracoldmatterlablive.appspot.com",
      messagingSenderId: "75894080963",
      appId: "1:75894080963:web:cfa41a9bd08d4f567f6976"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    // --- Chart.js Setup ---
    const ctx = document.getElementById('liveChart').getContext('2d');
    const chartData = {
      labels: [],
      datasets: [
        {
          label: 'Temperature (°C)',
          data: [],
          borderColor: 'rgba(255,99,132,1)',
          backgroundColor: 'rgba(255,99,132,0.1)',
          borderWidth: 3,
          fill: false,
          tension: 0.3,
          pointRadius: 2,
        },
        {
          label: 'Humidity (%)',
          data: [],
          borderColor: 'rgba(255,255,255,0.5)',
          borderDash: [8, 6],
          backgroundColor: 'rgba(255,255,255,0.1)',
          borderWidth: 3,
          fill: false,
          tension: 0.3,
          pointRadius: 2,
        }
      ]
    };
    const liveChart = new Chart(ctx, {
      type: 'line',
      data: chartData,
      options: {
        responsive: true,
        plugins: {
          legend: { labels: { color: "#fff" } }
        },
        scales: {
          x: { ticks: { color: "#ccc" } },
          y: { ticks: { color: "#ccc" }, beginAtZero: false }
        }
      }
    });

    // --- Serial Monitor Setup ---
    const serialMonitor = document.getElementById('serial-entries');
    const MAX_SERIAL_ENTRIES = 20;
    let serialBuffer = [];

    // --- Fetch and Stream Data ---
    // Change 'sensor1' to your sensor name if needed, or loop for multiple sensors
    const sensorRef = db.ref('sensors/sensor1');
    sensorRef.limitToLast(30).on('value', snapshot => {
      const data = snapshot.val();
      if (!data) return;
      // Sort by timestamp
      const entries = Object.entries(data).sort(([a], [b]) => a.localeCompare(b));
      // Reset chart data
      chartData.labels.length = 0;
      chartData.datasets[0].data.length = 0;
      chartData.datasets[1].data.length = 0;
      serialBuffer = [];
      entries.forEach(([timestamp, values]) => {
        // Add to chart
        chartData.labels.push(timestamp.slice(11,19)); // Show only HH:MM:SS
        chartData.datasets[0].data.push(values.temperature);
        chartData.datasets[1].data.push(values.humidity);
        // Add to serial buffer
        serialBuffer.push(
          `<div class="serial-entry">Sensor 1 &rarr; Temp: <b>${values.temperature.toFixed(2)} °C</b>, Hum: <b>${values.humidity.toFixed(2)} %</b> at <span style="color:#aaa">${timestamp}</span></div>`
        );
      });
      // Update chart
      liveChart.update();
      // Update serial monitor (show last MAX_SERIAL_ENTRIES)
      serialMonitor.innerHTML = serialBuffer.slice(-MAX_SERIAL_ENTRIES).reverse().join('');
    });

    // --- Optional: For Multiple Sensors ---
    // You can loop through 'sensors' node and repeat above logic for each sensor if needed.
  </script>
</body>
</html>
