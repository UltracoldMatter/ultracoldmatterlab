<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8" />
  <title>Ultracold Matter Lab Live Dashboard</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-database-compat.js"></script>
  <style>
    body {
      font-family: Arial, sans-serif;
      background: #f4f6f8;
      margin: 0;
      padding: 20px;
    }
    h2 {
      color: #333;
    }
    .card {
      background: #fff;
      padding: 20px;
      border-radius: 12px;
      box-shadow: 0 4px 10px rgba(0,0,0,0.1);
      margin-bottom: 20px;
    }
    #status {
      font-weight: bold;
      color: green;
    }
    .log {
      background: #111;
      color: #0f0;
      padding: 10px;
      font-family: monospace;
      height: 180px;
      overflow-y: auto;
      border-radius: 8px;
      font-size: 1.05em;
    }
    canvas {
      max-width: 100%;
      background: #eef;
      border-radius: 8px;
      margin-top: 10px;
    }
  </style>
</head>
<body>

  <h2>üå°Ô∏è Ultracold Matter Lab ‚Äì Live Temperature & Humidity (6 Sensors)</h2>

  <div class="card">
    <p>Status: <span id="status">Connecting...</span></p>
    <p>Last Update: <span id="timestamp">--</span></p>
  </div>

  <div class="card">
    <canvas id="liveChart" height="140"></canvas>
  </div>

  <div class="card">
    <h3>üìü Serial Monitor</h3>
    <div class="log" id="logOutput">Waiting for data...</div>
  </div>

  <script>
    // Firebase config
    const firebaseConfig = {
      apiKey: "AIzaSyATktR2jpo9ghUY0_MqpZh_KP5jrW-6YZE",
      authDomain: "ultracoldmatterlablive.firebaseapp.com",
      databaseURL: "https://ultracoldmatterlablive-default-rtdb.asia-southeast1.firebasedatabase.app",
      projectId: "ultracoldmatterlablive",
      storageBucket: "ultracoldmatterlablive.appspot.com",
      messagingSenderId: "75894080963",
      appId: "1:75894080963:web:cfa41a9bd08d4f567f6976"
    };

    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    const statusEl = document.getElementById('status');
    const timestampEl = document.getElementById('timestamp');
    const logEl = document.getElementById('logOutput');

    // Colors for 6 sensors
    const colors = [
      "#e6194b", // red
      "#3cb44b", // green
      "#4363d8", // blue
      "#f58231", // orange
      "#911eb4", // purple
      "#ffe119"  // yellow
    ];

    // Chart.js setup: 12 datasets (6 temp, 6 hum)
    const ctx = document.getElementById('liveChart').getContext('2d');
    const chart = new Chart(ctx, {
      type: 'line',
      data: {
        labels: [], // time labels
        datasets: [
          // Each sensor: temp (solid), hum (dashed)
          ...Array.from({length: 6}, (_, i) => ({
            label: `Sensor ${i+1} Temp (¬∞C)`,
            data: [],
            borderColor: colors[i],
            backgroundColor: colors[i],
            borderWidth: 2,
            fill: false,
            tension: 0.2,
            pointRadius: 1,
            borderDash: []
          })),
          ...Array.from({length: 6}, (_, i) => ({
            label: `Sensor ${i+1} Hum (%)`,
            data: [],
            borderColor: colors[i] + "99",
            backgroundColor: colors[i] + "99",
            borderWidth: 2,
            fill: false,
            tension: 0.2,
            pointRadius: 1,
            borderDash: [6, 6]
          }))
        ]
      },
      options: {
        responsive: true,
        scales: {
          x: {
            type: 'time',
            time: { tooltipFormat: 'yyyy-MM-dd HH:mm:ss', unit: 'minute', displayFormats: {minute: 'HH:mm:ss'} },
            title: { display: true, text: 'Time' }
          },
          y: {
            beginAtZero: true,
            title: { display: true, text: 'Value' }
          }
        },
        plugins: {
          legend: { display: true }
        }
      }
    });

    // Keep last 40 points per sensor
    const MAX_POINTS = 40;
    // Store latest timestamp per sensor
    let latestTimestamps = Array(6).fill(null);

    function updateSerialMonitor(latestReadings) {
      let lines = [];
      for (let i = 0; i < 6; i++) {
        const reading = latestReadings[i];
        if (reading) {
          lines.push(
            `Sensor ${i+1} -> Temp: ${reading.temperature?.toFixed(2) ?? '--'} ¬∞C, Hum: ${reading.humidity?.toFixed(2) ?? '--'} % at ${reading.timestamp}`
          );
        } else {
          lines.push(`Sensor ${i+1} -> No data`);
        }
      }
      logEl.textContent = lines.join('\n');
      logEl.scrollTop = logEl.scrollHeight;
    }

    function updateStatus(lastUpdate) {
      if (lastUpdate) {
        statusEl.textContent = "üü¢ Live";
        timestampEl.textContent = lastUpdate;
      } else {
        statusEl.textContent = "üî¥ Waiting for data...";
        timestampEl.textContent = "--";
      }
    }

    // Listen to all 6 sensors in real time
    function listenAllSensors() {
      let latestReadings = Array(6).fill(null);
      let allData = Array(6).fill(null).map(() => []);
      let lastOverallTime = null;

      for (let i = 0; i < 6; i++) {
        db.ref(`sensors/sensor${i+1}`).on('value', (snapshot) => {
          const data = snapshot.val();
          if (!data) return;
          // Convert to array of {timestamp, temperature, humidity}
          let arr = Object.entries(data).map(([timestamp, vals]) => ({
            timestamp,
            temperature: parseFloat(vals.temperature),
            humidity: parseFloat(vals.humidity)
          })).sort((a, b) => new Date(a.timestamp) - new Date(b.timestamp));
          allData[i] = arr.slice(-MAX_POINTS);

          // Update chart data for this sensor
          chart.data.datasets[i].data = allData[i].map(d => ({x: d.timestamp, y: d.temperature}));
          chart.data.datasets[6 + i].data = allData[i].map(d => ({x: d.timestamp, y: d.humidity}));

          // Update latest reading
          latestReadings[i] = arr.length > 0 ? arr[arr.length - 1] : null;
          latestTimestamps[i] = latestReadings[i]?.timestamp || null;

          // Update chart labels (x axis) with union of all timestamps
          let allTimestamps = allData.flat().map(d => d.timestamp);
          let uniqueTimestamps = Array.from(new Set(allTimestamps)).sort();
          chart.data.labels = uniqueTimestamps;

          // Update chart
          chart.update();

          // Update serial monitor and status
          let mostRecent = latestTimestamps.filter(Boolean).sort().slice(-1)[0];
          updateSerialMonitor(latestReadings);
          updateStatus(mostRecent ? new Date(mostRecent).toLocaleString() : null);
        });
      }
    }

    listenAllSensors();
  </script>

</body>
</html>
