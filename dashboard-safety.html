<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Live Dashboard - Temp & Humidity</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-database.js"></script>
  <style>
    body { font-family: Arial, sans-serif; padding: 20px; }
    .controls { margin-bottom: 10px; }
    .checkbox-group { display: flex; flex-wrap: wrap; gap: 10px; margin-bottom: 10px; }
    .serial-monitor { border: 1px solid #ccc; padding: 10px; height: 120px; overflow-y: auto; margin-top: 20px; background: #f9f9f9; }
    .status-panel { margin-top: 20px; }
    .status-panel span { font-weight: bold; }
  </style>
</head>
<body>
  <h2>Live Temperature and Humidity Dashboard</h2>
  <div class="controls">
    <div class="checkbox-group">
      <label><input type="checkbox" class="sensor-checkbox" data-sensor="sensor1" checked> Sensor 1</label>
      <label><input type="checkbox" class="sensor-checkbox" data-sensor="sensor2" checked> Sensor 2</label>
      <label><input type="checkbox" class="sensor-checkbox" data-sensor="sensor3" checked> Sensor 3</label>
      <label><input type="checkbox" class="sensor-checkbox" data-sensor="sensor4" checked> Sensor 4</label>
      <label><input type="checkbox" class="sensor-checkbox" data-sensor="sensor5" checked> Sensor 5</label>
      <label><input type="checkbox" class="sensor-checkbox" data-sensor="sensor6" checked> Sensor 6</label>
    </div>
    <label for="time-range">Select Time Range (minutes): </label>
    <select id="time-range">
      <option value="10">10</option>
      <option value="30">30</option>
      <option value="60">60</option>
    </select>
  </div>

  <canvas id="sensorChart" width="1000" height="400"></canvas>

  <div class="serial-monitor" id="serial-monitor"></div>

  <div class="status-panel">
    <p>Data Stream: <span id="data-stream-status">OFFLINE</span></p>
    <p>Last Updated: <span id="last-updated">--</span></p>
  </div>

  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyATktR2jpo9ghUY0_MqpZh_KP5jrW-6YZE",
      authDomain: "ultracoldmatterlablive.firebaseapp.com",
      databaseURL: "https://ultracoldmatterlablive-default-rtdb.asia-southeast1.firebasedatabase.app",
      projectId: "ultracoldmatterlablive",
      storageBucket: "ultracoldmatterlablive.appspot.com",
      messagingSenderId: "75894080963",
      appId: "1:75894080963:web:cfa41a9bd08d4f567f6976"
    };

    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    const sensors = ['sensor1', 'sensor2', 'sensor3', 'sensor4', 'sensor5', 'sensor6'];
    const colors = ['#FF0000', '#00FF00', '#0000FF', '#FF00FF', '#00FFFF', '#FFA500'];

    const datasets = [];
    sensors.forEach((sensor, i) => {
      const color = colors[i];
      datasets.push({
        label: `${sensor} Temp`,
        data: [],
        borderColor: color,
        backgroundColor: color,
        fill: false,
        tension: 0.1,
        hidden: false
      });
      datasets.push({
        label: `${sensor} Hum`,
        data: [],
        borderColor: color,
        backgroundColor: color,
        fill: false,
        tension: 0.1,
        borderDash: [5, 5],
        hidden: false
      });
    });

    const ctx = document.getElementById('sensorChart').getContext('2d');
    const sensorChart = new Chart(ctx, {
      type: 'line',
      data: { datasets },
      options: {
        responsive: true,
        scales: {
          x: {
            type: 'time',
            time: { unit: 'minute' },
            title: { display: true, text: 'Time' }
          },
          y: {
            title: { display: true, text: 'Value' }
          }
        }
      }
    });

    function updateChart(sensor, timestamp, temp, hum) {
      const t = new Date(timestamp);
      const index = sensors.indexOf(sensor);
      if (index === -1) return;
      datasets[index * 2].data.push({ x: t, y: temp });
      datasets[index * 2 + 1].data.push({ x: t, y: hum });
      document.getElementById('serial-monitor').innerHTML += `${sensor} > ${t.toLocaleTimeString()} > T: ${temp}, H: ${hum}<br>`;
      document.getElementById('serial-monitor').scrollTop = document.getElementById('serial-monitor').scrollHeight;
      document.getElementById('data-stream-status').textContent = 'ONLINE';
      document.getElementById('last-updated').textContent = new Date().toLocaleString();
      sensorChart.update();
    }

    sensors.forEach(sensor => {
      db.ref(`sensors/${sensor}`).limitToLast(50).on('child_added', snap => {
        const timestamp = snap.key;
        const { temperature, humidity } = snap.val();
        updateChart(sensor, timestamp, temperature, humidity);
      });
    });

    document.querySelectorAll('.sensor-checkbox').forEach((checkbox, i) => {
      checkbox.addEventListener('change', () => {
        const idx = i * 2;
        datasets[idx].hidden = !checkbox.checked;
        datasets[idx + 1].hidden = !checkbox.checked;
        sensorChart.update();
      });
    });

    document.getElementById('time-range').addEventListener('change', e => {
      const minutes = parseInt(e.target.value);
      const cutoff = new Date(Date.now() - minutes * 60000);
      datasets.forEach(ds => {
        ds.data = ds.data.filter(pt => pt.x >= cutoff);
      });
      sensorChart.update();
    });
  </script>
</body>
</html>
