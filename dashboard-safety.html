<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Live Dashboard - Safety Monitoring</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-database-compat.js"></script>
  <style>
    /* Include all your previous CSS here from your template */
  </style>
</head>
<body>

<!-- Your full navbar, headers, layout copied as-is -->
<!-- Only inserting the changed dynamic panel part below -->

<div class="left-panel">
  <div class="panel">
    <h2>Temperature & Humidity Panel</h2>
    <div class="checkbox-group">
      <label><input type="checkbox" class="sensor-toggle" value="sensor1" checked> Sensor 1</label>
      <label><input type="checkbox" class="sensor-toggle" value="sensor2" checked> Sensor 2</label>
      <label><input type="checkbox" class="sensor-toggle" value="sensor3" checked> Sensor 3</label>
      <label><input type="checkbox" class="sensor-toggle" value="sensor4" checked> Sensor 4</label>
      <label><input type="checkbox" class="sensor-toggle" value="sensor5" checked> Sensor 5</label>
      <label><input type="checkbox" class="sensor-toggle" value="sensor6" checked> Sensor 6</label>
    </div>
    <canvas id="liveChart" height="300"></canvas>
    <div class="serial-monitor" id="safety-serial">
      Serial Monitor: Combined Temperature & Humidity data streaming...
    </div>
  </div>
</div>

<!-- Right Panel -->
<div class="right-panel">
  <div class="time-selector">
    <h3>Time Range</h3>
    <select id="timeRange">
      <option value="10">Past 10 Minutes</option>
      <option value="15">Past 15 Minutes</option>
      <option value="30">Past 30 Minutes</option>
      <option value="60">Past 1 Hour</option>
      <option value="120">Past 2 Hours</option>
      <option value="180">Past 3 Hours</option>
      <option value="360">Past 6 Hours</option>
      <option value="720">Past 12 Hours</option>
      <option value="1440">Past 1 Day</option>
      <option value="2880">Past 2 Days</option>
      <option value="10080">Past 1 Week</option>
      <option value="43200">Past 1 Month</option>
    </select>
  </div>

  <div class="status">
    <h3>Status</h3>
    <p>Data Stream: <span id="streamStatus" style="color: green;">ONLINE</span></p>
    <p>Last Updated: <span id="last-updated">--</span></p>
    <hr>
    <h4>Sensor Status</h4>
    <ul id="sensor-status"></ul>
  </div>
</div>

<script>
  const firebaseConfig = {
    apiKey: "AIzaSyATktR2jpo9ghUY0_MqpZh_KP5jrW-6YZE",
    authDomain: "ultracoldmatterlablive.firebaseapp.com",
    databaseURL: "https://ultracoldmatterlablive-default-rtdb.asia-southeast1.firebasedatabase.app",
    projectId: "ultracoldmatterlablive",
    storageBucket: "ultracoldmatterlablive.firebasestorage.app",
    messagingSenderId: "75894080963",
    appId: "1:75894080963:web:cfa41a9bd08d4f567f6976"
  };
  firebase.initializeApp(firebaseConfig);
  const db = firebase.database();

  const chart = new Chart(document.getElementById('liveChart').getContext('2d'), {
    type: 'line',
    data: {
      labels: [],
      datasets: []
    },
    options: {
      responsive: true,
      animation: false,
      scales: {
        x: {
          type: 'time',
          time: { unit: 'minute', tooltipFormat: 'HH:mm:ss' }
        },
        y: { beginAtZero: true }
      }
    }
  });

  const colorMap = ['red', 'blue', 'green', 'orange', 'purple', 'brown'];
  const activeSensors = new Set(['sensor1','sensor2','sensor3','sensor4','sensor5','sensor6']);

  function createDatasets(sensor, color) {
    return [
      {
        label: `${sensor} Temp`,
        data: [],
        borderColor: color,
        fill: false,
        tension: 0.2
      },
      {
        label: `${sensor} Hum`,
        data: [],
        borderColor: color,
        borderDash: [5, 5],
        backgroundColor: 'transparent',
        fill: false,
        tension: 0.2,
        pointRadius: 2
      }
    ];
  }

  function updateSensorStatus(sensor, timestamp) {
    const statusList = document.getElementById('sensor-status');
    let el = document.getElementById(`${sensor}-status`);
    if (!el) {
      el = document.createElement('li');
      el.id = `${sensor}-status`;
      statusList.appendChild(el);
    }
    el.innerHTML = `${sensor.toUpperCase()}: <span style="color: green">ONLINE</span> (${timestamp})`;
  }

  function updateSerialLog(sensor, t, h, ts) {
    const log = document.getElementById('safety-serial');
    const msg = `[${ts}] ${sensor}: Temp: ${t}Â°C, Hum: ${h}%\n`;
    log.textContent += msg;
    log.scrollTop = log.scrollHeight;
  }

  function listenToSensor(sensor, color) {
    db.ref(`sensors/${sensor}`).limitToLast(1).on('child_added', snapshot => {
      const data = snapshot.val();
      const time = new Date(snapshot.key);
      const t = parseFloat(data.temperature);
      const h = parseFloat(data.humidity);

      updateSensorStatus(sensor, snapshot.key);
      updateSerialLog(sensor, t, h, snapshot.key);

      const label = time;
      chart.data.labels.push(label);

      const [tDataset, hDataset] = chart.data.datasets.filter(ds => ds.label.includes(sensor));
      if (tDataset && hDataset) {
        tDataset.data.push({ x: label, y: t });
        hDataset.data.push({ x: label, y: h });
      }

      if (chart.data.labels.length > 100) {
        chart.data.labels.shift();
        chart.data.datasets.forEach(ds => ds.data.shift());
      }
      chart.update();
    });
  }

  document.querySelectorAll('.sensor-toggle').forEach((cb, i) => {
    cb.addEventListener('change', () => {
      const sensor = cb.value;
      if (cb.checked) {
        activeSensors.add(sensor);
        chart.data.datasets.push(...createDatasets(sensor, colorMap[i]));
        listenToSensor(sensor, colorMap[i]);
      } else {
        activeSensors.delete(sensor);
        chart.data.datasets = chart.data.datasets.filter(ds => !ds.label.includes(sensor));
      }
      chart.update();
    });
  });

  window.onload = () => {
    activeSensors.forEach((sensor, i) => {
      chart.data.datasets.push(...createDatasets(sensor, colorMap[i]));
      listenToSensor(sensor, colorMap[i]);
    });
  };
</script>

</body>
</html>
