<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Live Dashboard - Safety Monitoring</title>
  <style>
    body {
      margin: 0;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background-color: #f9f9f9;
      display: flex;
      flex-direction: column;
      min-height: 100vh;
    }
    .navbar {
      background-color: #ffffff;
      color: #003366;
      padding: 1rem 2rem;
      display: flex;
      justify-content: flex-end;
      align-items: center;
      border-bottom: 2px solid #ccc;
    }
    .nav-links a {
      color: #003366;
      text-decoration: none;
      margin-left: 1.5rem;
      font-weight: 600;
    }
    .nav-links a:hover {
      text-decoration: underline;
    }
    .lab-header {
      background-color: #004080;
      color: white;
      padding: 1.5rem;
      text-align: center;
      font-size: 1.8rem;
      font-weight: bold;
      border-top: 4px solid #002244;
      border-bottom: 4px solid #002244;
    }
    .sub-header {
      text-align: center;
      font-size: 0.9rem;
      color: #444;
      padding: 0.5rem 1rem;
    }
    .main-container {
      flex: 1;
      display: flex;
      flex-direction: row;
      padding: 1rem;
    }
    .left-panel {
      flex: 3;
      padding-right: 1rem;
    }
    .right-panel {
      flex: 1;
      border-left: 2px solid #ccc;
      padding-left: 1rem;
    }
    .panel {
      background: white;
      padding: 1rem;
      margin-bottom: 1rem;
      border: 1px solid #ccc;
      border-radius: 8px;
    }
    .panel h2 {
      color: #003366;
    }
    .checkbox-group {
      margin: 0.5rem 0;
    }
    .checkbox-group label {
      margin-right: 1rem;
    }
    .serial-monitor {
      background: #000;
      color: #0f0;
      font-family: monospace;
      height: 120px;
      overflow-y: auto;
      padding: 0.5rem;
      border-radius: 4px;
      margin-top: 0.5rem;
      font-size: 0.96rem;
    }
    .time-selector {
      margin-bottom: 2rem;
    }
    .time-selector h3,
    .status h3 {
      color: #003366;
    }
    select {
      padding: 0.5rem;
      width: 100%;
      margin-top: 0.5rem;
    }
    .status {
      margin-top: 1rem;
    }
    .status span {
      font-weight: bold;
    }
    .sensor-status {
      margin-top: 1rem;
      background: #f6f6f6;
      border-radius: 6px;
      padding: 0.5rem 1rem;
      font-size: 1rem;
    }
    .sensor-on { color: green; }
    .sensor-off { color: red; }
    .footer {
      background-color: #003366;
      height: 60px;
      margin-top: auto;
    }
    canvas {
      background: #eef;
      border: 1px dashed #888;
      margin-top: 1rem;
      border-radius: 6px;
    }
  </style>
  <!-- Chart.js CDN -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <!-- Firebase CDN -->
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-database-compat.js"></script>
</head>
<body>

<!-- Navigation Bar -->
<div class="navbar">
  <div class="nav-links">
    <a href="index.html">Home</a>
    <a href="description.html">Description</a>
    <a href="dashboard-temp-humidity.html">Live Dashboard - Temperature & Humidity</a>
    <a href="dashboard-safety.html">Live Dashboard - Safety Monitoring</a>
  </div>
</div>

<!-- Header -->
<div class="lab-header">
  ULTRACOLD MATTER LAB
</div>

<div class="sub-header">
  Hemvati Nandan Bahuguna Garhwal University (A Central University), Srinagar, Uttarakhand, India (249161)
</div>

<!-- Main Content -->
<div class="main-container">

  <!-- Left: Combined Panel -->
  <div class="left-panel">
    <div class="panel">
      <h2>Temperature & Humidity Panel</h2>
      <div class="checkbox-group" id="sensor-checkboxes">
        <label><input type="checkbox" value="1" checked> Sensor 1</label>
        <label><input type="checkbox" value="2" checked> Sensor 2</label>
        <label><input type="checkbox" value="3" checked> Sensor 3</label>
        <label><input type="checkbox" value="4" checked> Sensor 4</label>
        <label><input type="checkbox" value="5" checked> Sensor 5</label>
        <label><input type="checkbox" value="6" checked> Sensor 6</label>
      </div>
      <!-- Chart.js graph -->
      <canvas id="liveChart" height="300"></canvas>
      <div class="serial-monitor" id="safety-serial">
        Serial Monitor: Combined Temperature & Humidity data streaming...
      </div>
    </div>
  </div>

  <!-- Right: Time and Status -->
  <div class="right-panel">
    <div class="time-selector">
      <h3>Time Range</h3>
      <select id="time-range">
        <option value="10">Past 10 Minutes</option>
        <option value="15">Past 15 Minutes</option>
        <option value="30">Past 30 Minutes</option>
        <option value="60">Past 1 Hour</option>
        <option value="120">Past 2 Hours</option>
        <option value="180">Past 3 Hours</option>
        <option value="360">Past 6 Hours</option>
        <option value="720">Past 12 Hours</option>
        <option value="1440">Past 1 Day</option>
        <option value="2880">Past 2 Days</option>
        <option value="10080">Past 1 Week</option>
        <option value="43200">Past 1 Month</option>
      </select>
    </div>
    <div class="status">
      <h3>Status</h3>
      <p>Data Stream: <span id="data-status" style="color: green;">ONLINE</span></p>
      <p>Last Updated: <span id="last-updated">-</span></p>
    </div>
    <div class="sensor-status" id="sensor-status">
      <!-- Sensor status will appear here -->
    </div>
  </div>
</div>

<!-- Footer -->
<div class="footer"></div>

<script>
  // Firebase config
  const firebaseConfig = {
    apiKey: "AIzaSyATktR2jpo9ghUY0_MqpZh_KP5jrW-6YZE",
    authDomain: "ultracoldmatterlablive.firebaseapp.com",
    databaseURL: "https://ultracoldmatterlablive-default-rtdb.asia-southeast1.firebasedatabase.app",
    projectId: "ultracoldmatterlablive",
    storageBucket: "ultracoldmatterlablive.appspot.com",
    messagingSenderId: "75894080963",
    appId: "1:75894080963:web:cfa41a9bd08d4f567f6976"
  };
  firebase.initializeApp(firebaseConfig);
  const db = firebase.database();

  // Chart.js color palette for 6 sensors
  const colorPalette = [
    "#e6194b", // Sensor 1 - Red
    "#3cb44b", // Sensor 2 - Green
    "#4363d8", // Sensor 3 - Blue
    "#f58231", // Sensor 4 - Orange
    "#911eb4", // Sensor 5 - Purple
    "#ffe119"  // Sensor 6 - Yellow
  ];

  // Helper to lighten a color (for humidity lines)
  function lightenColor(hex, percent) {
    hex = hex.replace('#','');
    let r = parseInt(hex.substring(0,2),16);
    let g = parseInt(hex.substring(2,4),16);
    let b = parseInt(hex.substring(4,6),16);
    r = Math.round(r + (255 - r) * percent / 100);
    g = Math.round(g + (255 - g) * percent / 100);
    b = Math.round(b + (255 - b) * percent / 100);
    return `rgba(${r},${g},${b},0.85)`;
  }

  // Chart.js datasets
  let chart, chartData, chartOptions;
  function createChart() {
    const ctx = document.getElementById('liveChart').getContext('2d');
    chartData = {
      datasets: []
    };
    chartOptions = {
      responsive: true,
      maintainAspectRatio: false,
      parsing: false,
      animation: false,
      plugins: {
        legend: { display: true }
      },
      scales: {
        x: {
          type: 'time',
          time: { tooltipFormat: 'yyyy-MM-dd HH:mm:ss', unit: 'minute' },
          title: { display: true, text: 'Time' }
        },
        y: {
          title: { display: true, text: 'Value' },
          min: 0,
          max: 60
        }
      }
    };
    chart = new Chart(ctx, {
      type: 'line',
      data: chartData,
      options: chartOptions
    });
  }

  // State
  let sensorData = [ {}, {}, {}, {}, {}, {} ]; // sensorData[0] for sensor1, ...
  let latestTimestamps = Array(6).fill(null);
  let lastOverallTimestamp = null;
  let sensorEnabled = [true, true, true, true, true, true];

  // Fetch and update data
  function fetchData() {
    const timeRangeMinutes = parseInt(document.getElementById('time-range').value);
    const now = new Date();
    const minTime = new Date(now.getTime() - timeRangeMinutes * 60000);

    let promises = [];
    for (let i = 1; i <= 6; i++) {
      promises.push(
        db.ref(`/sensors/sensor${i}`).once('value').then(snapshot => {
          const data = snapshot.val() || {};
          let filtered = [];
          let latest = null;
          for (const [ts, vals] of Object.entries(data)) {
            const date = new Date(ts);
            if (date >= minTime && date <= now && vals.temperature !== undefined && vals.humidity !== undefined) {
              filtered.push({ timestamp: ts, ...vals });
            }
            if (!latest || new Date(ts) > new Date(latest.timestamp)) {
              latest = { timestamp: ts, ...vals };
            }
          }
          sensorData[i-1] = filtered.sort((a,b) => new Date(a.timestamp) - new Date(b.timestamp));
          latestTimestamps[i-1] = latest ? latest.timestamp : null;
        })
      );
    }
    Promise.all(promises).then(() => {
      updateChart();
      updateSerialMonitor();
      updateStatus();
      updateSensorStatus();
    });
  }

  // Update Chart.js graph
  function updateChart() {
    chartData.datasets = [];
    for (let i = 0; i < 6; i++) {
      if (!sensorEnabled[i]) continue;
      // Temperature (solid)
      chartData.datasets.push({
        label: `Sensor ${i+1} Temp`,
        data: sensorData[i].map(d => ({ x: d.timestamp, y: d.temperature })),
        borderColor: colorPalette[i],
        backgroundColor: colorPalette[i],
        borderWidth: 2,
        fill: false,
        tension: 0.2,
        pointRadius: 1,
        yAxisID: 'y',
        borderDash: []
      });
      // Humidity (dotted, lighter)
      chartData.datasets.push({
        label: `Sensor ${i+1} Hum`,
        data: sensorData[i].map(d => ({ x: d.timestamp, y: d.humidity })),
        borderColor: lightenColor(colorPalette[i], 50),
        backgroundColor: lightenColor(colorPalette[i], 50),
        borderWidth: 2,
        fill: false,
        tension: 0.2,
        pointRadius: 1,
        yAxisID: 'y',
        borderDash: [6, 6]
      });
    }
    chart.update();
  }

  // Update Serial Monitor
  function updateSerialMonitor() {
    let lines = [];
    for (let i = 0; i < 6; i++) {
      if (!sensorEnabled[i]) continue;
      const latest = sensorData[i].length > 0 ? sensorData[i][sensorData[i].length-1] : null;
      if (latest) {
        lines.push(`Sensor ${i+1} -> Temp: ${latest.temperature?.toFixed(2) ?? '--'} °C, Hum: ${latest.humidity?.toFixed(2) ?? '--'} % at ${latest.timestamp}`);
      } else {
        lines.push(`Sensor ${i+1} -> No recent data.`);
      }
    }
    document.getElementById('safety-serial').innerHTML = lines.join('<br>');
  }

  // Update right-panel status
  function updateStatus() {
    // Last updated = latest among all sensors
    let lastTs = null;
    for (let ts of latestTimestamps) {
      if (ts && (!lastTs || new Date(ts) > new Date(lastTs))) lastTs = ts;
    }
    lastOverallTimestamp = lastTs;
    document.getElementById('last-updated').textContent = lastTs ? formatTimestamp(lastTs) : '-';
    // Data Stream status
    const now = new Date();
    let online = lastTs && (now - new Date(lastTs) < 2 * 60 * 1000); // online if updated in last 2 min
    document.getElementById('data-status').style.color = online ? 'green' : 'red';
    document.getElementById('data-status').textContent = online ? 'ONLINE' : 'OFFLINE';
  }

  // Update sensor on/off status
  function updateSensorStatus() {
    let html = '<b>Sensors Status:</b><br>';
    const now = new Date();
    for (let i = 0; i < 6; i++) {
      let status = 'OFF';
      let colorClass = 'sensor-off';
      if (latestTimestamps[i] && (now - new Date(latestTimestamps[i]) < 2 * 60 * 1000)) {
        status = 'ON';
        colorClass = 'sensor-on';
      }
      html += `<span class="${colorClass}">Sensor ${i+1}: ${status}</span><br>`;
    }
    document.getElementById('sensor-status').innerHTML = html;
  }

  // Format timestamp
  function formatTimestamp(ts) {
    const d = new Date(ts);
    if (isNaN(d)) return ts;
    return d.toLocaleString('en-IN', { hour12: true });
  }

  // Checkbox event listeners
  document.getElementById('sensor-checkboxes').addEventListener('change', function(e) {
    if (e.target.type === 'checkbox') {
      const idx = parseInt(e.target.value) - 1;
      sensorEnabled[idx] = e.target.checked;
      updateChart();
      updateSerialMonitor();
    }
  });

  // Time range change
  document.getElementById('time-range').addEventListener('change', fetchData);

  // Initial setup
  createChart();
  fetchData();

  // Poll every 10 seconds for new data
  setInterval(fetchData, 10000);
</script>
</body>
</html>
