<!DOCTYPE html>
<html>
<head>
  <title>Ultra-cold Lab Live Dashboard</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-database-compat.js"></script>
  <style>
    body {
      display: flex;
      font-family: sans-serif;
      background: #f4f4f4;
    }
    .left {
      flex: 3;
      padding: 20px;
    }
    .right {
      flex: 1;
      padding: 20px;
      border-left: 1px solid #ccc;
    }
    .status {
      margin-bottom: 20px;
    }
    .status span {
      display: inline-block;
      width: 10px;
      height: 10px;
      border-radius: 50%;
      margin-right: 5px;
    }
    #serialMonitor {
      background: black;
      color: lime;
      padding: 10px;
      height: 200px;
      overflow-y: scroll;
      white-space: pre-wrap;
    }
  </style>
</head>
<body>
  <div class="left">
    <h2>Live Temperature & Humidity</h2>
    <canvas id="sensorChart" height="150"></canvas>
    <div>
      <label>Time Window: </label>
      <select id="timeWindow">
        <option value="5">Last 5 min</option>
        <option value="15">Last 15 min</option>
        <option value="30">Last 30 min</option>
        <option value="60">Last 60 min</option>
      </select>
    </div>
    <div id="sensorToggles"></div>
    <h3>Serial Monitor</h3>
    <div id="serialMonitor">Waiting for data...</div>
  </div>
  <div class="right">
    <h3>Sensor Status</h3>
    <div id="statusPanel"></div>
  </div>

  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyATktR2jpo9ghUY0_MqpZh_KP5jrW-6YZE",
      authDomain: "ultracoldmatterlablive.firebaseapp.com",
      databaseURL: "https://ultracoldmatterlablive-default-rtdb.asia-southeast1.firebasedatabase.app",
      projectId: "ultracoldmatterlablive",
      storageBucket: "ultracoldmatterlablive.appspot.com",
      messagingSenderId: "75894080963",
      appId: "1:75894080963:web:cfa41a9bd08d4f567f6976"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    const sensorChart = new Chart(document.getElementById("sensorChart"), {
      type: 'line',
      data: { labels: [], datasets: [] },
      options: {
        responsive: true,
        interaction: { mode: 'index', intersect: false },
        plugins: { legend: { position: 'bottom' } },
        scales: {
          x: { type: 'time', time: { unit: 'minute' } },
          y: { title: { display: true, text: 'Value' } }
        }
      }
    });

    const sensorColors = ['red', 'blue', 'green', 'orange', 'purple', 'brown'];
    const serialMonitor = document.getElementById("serialMonitor");
    const statusPanel = document.getElementById("statusPanel");
    const sensorToggles = document.getElementById("sensorToggles");
    const timeWindow = document.getElementById("timeWindow");
    let sensors = Array.from({length: 6}, (_, i) => `sensor${i+1}`);
    let latestData = {};

    function createDatasets() {
      sensorChart.data.datasets = [];
      sensors.forEach((sensor, i) => {
        const color = sensorColors[i];
        sensorChart.data.datasets.push(
          { label: `${sensor} Temp`, data: [], borderColor: color, backgroundColor: color, hidden: false },
          { label: `${sensor} Hum`, data: [], borderColor: color, backgroundColor: color, borderDash: [5,5], hidden: false, opacity: 0.5 }
        );
      });
    }

    function updateChart(sensor, temp, hum, timestamp) {
      const t = new Date(timestamp);
      const tempDataset = sensorChart.data.datasets.find(d => d.label === `${sensor} Temp`);
      const humDataset = sensorChart.data.datasets.find(d => d.label === `${sensor} Hum`);
      if (tempDataset && humDataset) {
        tempDataset.data.push({x: t, y: parseFloat(temp)});
        humDataset.data.push({x: t, y: parseFloat(hum)});
        // Trim to time window
        const minutes = parseInt(timeWindow.value);
        const cutoff = Date.now() - minutes * 60 * 1000;
        tempDataset.data = tempDataset.data.filter(p => new Date(p.x).getTime() > cutoff);
        humDataset.data = humDataset.data.filter(p => new Date(p.x).getTime() > cutoff);
      }
      sensorChart.update();
    }

    function updateSerialMonitor(logEntry) {
      const lines = serialMonitor.textContent.split('\n');
      if (lines.length >= 10) lines.shift();
      lines.push(logEntry);
      serialMonitor.textContent = lines.join('\n');
      serialMonitor.scrollTop = serialMonitor.scrollHeight;
    }

    function updateStatus(sensor, timestamp) {
      const now = Date.now();
      const updated = new Date(timestamp).getTime();
      const age = now - updated;
      const dot = age < 60000 ? 'green' : (age < 300000 ? 'red' : 'black');
      document.getElementById(`${sensor}_status`).innerHTML =
        `<span style='background:${dot}'></span>${sensor} <br><small>${new Date(timestamp).toLocaleTimeString()}</small>`;
    }

    function setupUI() {
      sensors.forEach(sensor => {
        const cb = document.createElement("input");
        cb.type = "checkbox";
        cb.id = sensor;
        cb.checked = true;
        cb.onchange = () => {
          const tempDataset = sensorChart.data.datasets.find(d => d.label === `${sensor} Temp`);
          const humDataset = sensorChart.data.datasets.find(d => d.label === `${sensor} Hum`);
          if (tempDataset && humDataset) {
            tempDataset.hidden = humDataset.hidden = !cb.checked;
            sensorChart.update();
          }
        };
        const label = document.createElement("label");
        label.appendChild(cb);
        label.appendChild(document.createTextNode(" "+sensor));
        sensorToggles.appendChild(label);
        sensorToggles.appendChild(document.createElement("br"));

        const stat = document.createElement("div");
        stat.id = `${sensor}_status`;
        stat.className = "status";
        statusPanel.appendChild(stat);
      });
    }

    function listenToFirebase() {
      db.ref("sensorData").limitToLast(100).on("child_added", snap => {
        const d = snap.val();
        const { sensorId, temperature, humidity, timestamp } = d;
        if (!sensors.includes(sensorId)) return;

        latestData[sensorId] = timestamp;
        updateChart(sensorId, temperature, humidity, timestamp);
        updateSerialMonitor(`[${timestamp}] ${sensorId} → Temp: ${temperature}°C, Hum: ${humidity}%`);
        updateStatus(sensorId, timestamp);
      });
    }

    timeWindow.onchange = () => {
      createDatasets();
      sensorChart.update();
    };

    setupUI();
    createDatasets();
    listenToFirebase();
  </script>
</body>
</html>
