<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>Live Dashboard - Temperature & Humidity</title>
    <style>
        body {
            margin: 0;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #f9f9f9;
            display: flex;
            flex-direction: column;
            min-height: 100vh;
        }
        .navbar {
            background-color: #ffffff;
            color: #003366;
            padding: 1rem 2rem;
            display: flex;
            justify-content: flex-end;
            align-items: center;
            border-bottom: 2px solid #ccc;
        }
        .nav-links a {
            color: #003366;
            text-decoration: none;
            margin-left: 1.5rem;
            font-weight: 600;
        }
        .nav-links a:hover {
            text-decoration: underline;
        }
        .lab-header {
            background-color: #004080;
            color: white;
            padding: 1.5rem;
            text-align: center;
            font-size: 1.8rem;
            font-weight: bold;
            border-top: 4px solid #002244;
            border-bottom: 4px solid #002244;
        }
        .sub-header {
            text-align: center;
            font-size: 0.9rem;
            color: #444;
            padding: 0.5rem 1rem;
        }
        .main-container {
            flex: 1;
            display: flex;
            flex-direction: row;
            padding: 1rem;
        }
        .left-panel {
            flex: 3;
            padding-right: 1rem;
        }
        .right-panel {
            flex: 1;
            border-left: 2px solid #ccc;
            padding-left: 1rem;
        }
        .panel {
            background: white;
            padding: 1rem;
            margin-bottom: 1rem;
            border: 1px solid #ccc;
            border-radius: 8px;
        }
        .panel h2 {
            color: #003366;
            margin-top: 0;
        }
        .checkbox-group {
            margin: 1rem 0;
            display: flex;
            flex-wrap: wrap;
            gap: 1rem;
        }
        .checkbox-group label {
            display: flex;
            align-items: center;
            cursor: pointer;
        }
        .checkbox-group input[type="checkbox"] {
            margin-right: 0.5rem;
        }
        .chart-container {
            position: relative;
            height: 400px;
            margin: 1rem 0;
        }
        .serial-monitor {
            background: #000;
            color: #0f0;
            font-family: 'Courier New', monospace;
            height: 140px;
            overflow-y: auto;
            padding: 0.5rem;
            border-radius: 4px;
            margin-top: 1rem;
            font-size: 1rem;
            line-height: 1.6;
            white-space: pre-line;
        }
        .time-selector {
            margin-bottom: 2rem;
        }
        .time-selector h3,
        .status h3 {
            color: #003366;
            margin-top: 0;
        }
        select {
            padding: 0.5rem;
            width: 100%;
            margin-top: 0.5rem;
            border: 1px solid #ccc;
            border-radius: 4px;
        }
        .status {
            margin-top: 1rem;
        }
        .status p {
            margin: 0.5rem 0;
        }
        .status span {
            font-weight: bold;
        }
        .sensor-status {
            margin: 0.3rem 0;
            font-size: 0.97rem;
        }
        .footer {
            background-color: #003366;
            height: 60px;
            margin-top: auto;
        }
    </style>
    <!-- Chart.js CDN -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
</head>
<body>

<!-- Navigation Bar -->
<div class="navbar">
    <div class="nav-links">
        <a href="index.html">Home</a>
        <a href="description.html">Description</a>
        <a href="dashboard-temp-humidity.html">Live Dashboard - Temperature & Humidity</a>
        <a href="dashboard-safety.html">Live Dashboard - Safety Monitoring</a>
    </div>
</div>

<!-- Header -->
<div class="lab-header">
    ULTRACOLD MATTER LAB
</div>

<div class="sub-header">
    Hemvati Nandan Bahuguna Garhwal University (A Central University), Srinagar, Uttarakhand, India (249161)
</div>

<!-- Main Content -->
<div class="main-container">

    <!-- Left: Combined Panel -->
    <div class="left-panel">
        <div class="panel">
            <h2>Temperature & Humidity Panel</h2>
            <div class="checkbox-group" id="sensor-checkboxes">
                <!-- Checkboxes will be generated by JavaScript -->
            </div>
            <!-- Combined Chart -->
            <div class="chart-container">
                <canvas id="combinedChart"></canvas>
            </div>
            <div class="serial-monitor" id="serial-monitor">
                Serial Monitor: Combined Temperature & Humidity data streaming...
            </div>
        </div>
    </div>

    <!-- Right: Time and Status -->
    <div class="right-panel">
        <div class="time-selector">
            <h3>Time Range</h3>
            <select id="time-range">
                <option value="10">Past 10 Minutes</option>
                <option value="15">Past 15 Minutes</option>
                <option value="30">Past 30 Minutes</option>
                <option value="60" selected>Past 1 Hour</option>
                <option value="120">Past 2 Hours</option>
                <option value="180">Past 3 Hours</option>
                <option value="360">Past 6 Hours</option>
                <option value="720">Past 12 Hours</option>
                <option value="1440">Past 1 Day</option>
                <option value="2880">Past 2 Days</option>
                <option value="10080">Past 1 Week</option>
                <option value="43200">Past 1 Month</option>
            </select>
        </div>

        <div class="status">
            <h3>Status</h3>
            <p>Data Stream: <span id="stream-status" style="color: green;">ONLINE</span></p>
            <p>Last Updated: <span id="last-updated">-</span></p>
            <div id="sensor-status-list">
                <!-- Sensor status will be populated by JavaScript -->
            </div>
        </div>
    </div>
</div>

<!-- Footer -->
<div class="footer"></div>

<script>
// --- Firebase Configuration ---
const firebaseConfig = {
    apiKey: "AIzaSyATktR2jpo9ghUY0_MqpZh_KP5jrW-6YZE",
    authDomain: "ultracoldmatterlablive.firebaseapp.com",
    databaseURL: "https://ultracoldmatterlablive-default-rtdb.asia-southeast1.firebasedatabase.app",
    projectId: "ultracoldmatterlablive",
    storageBucket: "ultracoldmatterlablive.appspot.com",
    messagingSenderId: "75894080963",
    appId: "1:75894080963:web:cfa41a9bd08d4f567f6976"
};
firebase.initializeApp(firebaseConfig);
const database = firebase.database();

const NUM_SENSORS = 6;
const SENSOR_COLORS = [
    "#FF6B6B", "#4ECDC4", "#45B7D1", "#FFA726", "#AB47BC", "#66BB6A"
];

let chart;
let sensorData = {};
let sensorVisible = Array(NUM_SENSORS).fill(true);

const ctx = document.getElementById('combinedChart').getContext('2d');
const serialMonitor = document.getElementById('serial-monitor');
const timeRangeSelect = document.getElementById('time-range');
const lastUpdatedSpan = document.getElementById('last-updated');
const streamStatusSpan = document.getElementById('stream-status');
const sensorStatusList = document.getElementById('sensor-status-list');
const sensorCheckboxesDiv = document.getElementById('sensor-checkboxes');

// --- Checkboxes ---
function createCheckboxes() {
    sensorCheckboxesDiv.innerHTML = '';
    for (let i = 0; i < NUM_SENSORS; i++) {
        const label = document.createElement('label');
        const checkbox = document.createElement('input');
        checkbox.type = 'checkbox';
        checkbox.checked = true;
        checkbox.addEventListener('change', () => {
            sensorVisible[i] = checkbox.checked;
            updateChart();
        });
        label.appendChild(checkbox);
        label.appendChild(document.createTextNode(`Sensor ${i + 1}`));
        sensorCheckboxesDiv.appendChild(label);
    }
}

// --- Chart.js Setup ---
function createChart() {
    const datasets = [];
    for (let i = 0; i < NUM_SENSORS; i++) {
        // Temperature (solid)
        datasets.push({
            label: `Sensor ${i + 1} Temp`,
            data: [],
            borderColor: SENSOR_COLORS[i],
            backgroundColor: SENSOR_COLORS[i],
            borderWidth: 2,
            fill: false,
            tension: 0.3,
            pointRadius: 3,
            pointHoverRadius: 5,
            yAxisID: 'y',
            hidden: !sensorVisible[i]
        });
        // Humidity (dashed, transparent)
        datasets.push({
            label: `Sensor ${i + 1} Hum`,
            data: [],
            borderColor: hexToRgba(SENSOR_COLORS[i], 0.5),
            backgroundColor: hexToRgba(SENSOR_COLORS[i], 0.5),
            borderWidth: 2,
            fill: false,
            tension: 0.3,
            borderDash: [6, 6],
            pointRadius: 3,
            pointHoverRadius: 5,
            yAxisID: 'y1',
            hidden: !sensorVisible[i]
        });
    }
    chart = new Chart(ctx, {
        type: 'line',
        data: {
            labels: [],
            datasets: datasets
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    display: true,
                    labels: {
                        usePointStyle: true,
                        font: { size: 13 }
                    }
                }
            },
            interaction: {
                mode: 'nearest',
                intersect: false,
            },
            scales: {
                x: {
                    display: true,
                    title: { display: true, text: 'Time' },
                    grid: { color: '#eee', lineWidth: 1 }
                },
                y: {
                    type: 'linear',
                    display: true,
                    position: 'left',
                    title: { display: true, text: 'Temperature (°C)' },
                    grid: { color: '#eee', lineWidth: 1 }
                },
                y1: {
                    type: 'linear',
                    display: true,
                    position: 'right',
                    title: { display: true, text: 'Humidity (%)' },
                    grid: { drawOnChartArea: false }
                }
            }
        }
    });
}

// --- Utility: Convert Hex to RGBA ---
function hexToRgba(hex, alpha) {
    let c = hex.replace('#', '');
    if (c.length === 3) c = c.split('').map(x => x + x).join('');
    const num = parseInt(c, 16);
    return `rgba(${(num >> 16) & 255}, ${(num >> 8) & 255}, ${num & 255}, ${alpha})`;
}

// --- Real-time Listeners ---
function setupRealtimeListeners() {
    for (let i = 1; i <= NUM_SENSORS; i++) {
        database.ref(`/sensors/sensor${i}`).off();
    }
    sensorData = {};

    const timeRange = parseInt(timeRangeSelect.value);
    const cutoffTime = Date.now() - (timeRange * 60 * 1000);

    for (let i = 1; i <= NUM_SENSORS; i++) {
        database.ref(`/sensors/sensor${i}`)
            .orderByKey()
            .startAt(formatFirebaseTimestamp(cutoffTime))
            .on('value', (snapshot) => {
                sensorData[`sensor${i}`] = [];
                snapshot.forEach((childSnapshot) => {
                    const key = childSnapshot.key;
                    const data = childSnapshot.val();
                    // Only process keys that look like timestamps and have both temperature & humidity
                    if (
                        /^\d{4}-\d{2}-\d{2}T\d{2}:\d{2}:\d{2}$/.test(key) &&
                        typeof data === 'object' &&
                        data.temperature !== undefined &&
                        data.humidity !== undefined
                    ) {
                        sensorData[`sensor${i}`].push({
                            timestamp: key,
                            temperature: parseFloat(data.temperature),
                            humidity: parseFloat(data.humidity)
                        });
                    }
                });
                updateChart();
                updateSerialMonitor();
                updateSensorStatus();
            }, (error) => {
                streamStatusSpan.textContent = 'OFFLINE';
                streamStatusSpan.style.color = 'red';
            });
    }
}

// Helper for Firebase timestamp format
function formatFirebaseTimestamp(timestamp) {
    return new Date(timestamp).toISOString().slice(0, 19);
}

// --- Update Chart ---
function updateChart() {
    if (!chart) return;
    const allTimestamps = new Set();
    Object.values(sensorData).forEach(sensorArray => {
        sensorArray.forEach(item => allTimestamps.add(item.timestamp));
    });
    const sortedTimestamps = Array.from(allTimestamps).sort();
    chart.data.labels = sortedTimestamps.map(ts => {
        const d = new Date(ts);
        if (!isNaN(d.getTime())) return d.toLocaleTimeString();
        return ts.split('T')[1] || ts;
    });

    for (let i = 0; i < NUM_SENSORS; i++) {
        const sensorKey = `sensor${i + 1}`;
        const tempData = [];
        const humData = [];
        sortedTimestamps.forEach(timestamp => {
            const dataPoint = sensorData[sensorKey]?.find(item => item.timestamp === timestamp);
            tempData.push(dataPoint ? dataPoint.temperature : null);
            humData.push(dataPoint ? dataPoint.humidity : null);
        });
        chart.data.datasets[i * 2].data = tempData;
        chart.data.datasets[i * 2].hidden = !sensorVisible[i];
        chart.data.datasets[i * 2 + 1].data = humData;
        chart.data.datasets[i * 2 + 1].hidden = !sensorVisible[i];
    }
    chart.update('none');
    // Last updated
    if (sortedTimestamps.length > 0) {
        const lastTimestamp = sortedTimestamps[sortedTimestamps.length - 1];
        const d = new Date(lastTimestamp);
        lastUpdatedSpan.textContent = !isNaN(d.getTime()) ? d.toLocaleString() : lastTimestamp;
        streamStatusSpan.textContent = 'ONLINE';
        streamStatusSpan.style.color = 'green';
    }
}

// --- Update Serial Monitor (NEAT FORMAT) ---
function updateSerialMonitor() {
    let output = '';
    for (let i = 1; i <= NUM_SENSORS; i++) {
        const sensorKey = `sensor${i}`;
        if (sensorData[sensorKey] && sensorData[sensorKey].length > 0) {
            const latest = sensorData[sensorKey][sensorData[sensorKey].length - 1];
            output += `Sensor ${i} -> Temp: ${latest.temperature?.toFixed(2)} °C, Hum: ${latest.humidity?.toFixed(2)} % at ${latest.timestamp}\n\n`;
        }
    }
    serialMonitor.textContent = output || 'Serial Monitor: Waiting for data...';
    serialMonitor.scrollTop = serialMonitor.scrollHeight;
}

// --- Update Sensor Status (LIVE) ---
function updateSensorStatus() {
    let statusHTML = '';
    for (let i = 1; i <= NUM_SENSORS; i++) {
        const sensorKey = `sensor${i}`;
        let status = 'OFF', color = 'red';
        if (sensorData[sensorKey] && sensorData[sensorKey].length > 0) {
            const latest = sensorData[sensorKey][sensorData[sensorKey].length - 1];
            const ts = latest.timestamp.replace(' ', 'T');
            const lastUpdateTime = Date.parse(ts);
            const now = Date.now();
            if (!isNaN(lastUpdateTime) && (now - lastUpdateTime < 30000)) {
                status = 'ON';
                color = 'green';
            }
        }
        statusHTML += `<div class="sensor-status">Sensor ${i}: <span style="color: ${color};">${status}</span></div>`;
    }
    sensorStatusList.innerHTML = statusHTML;
}

// --- Event Listeners ---
timeRangeSelect.addEventListener('change', setupRealtimeListeners);

// --- Initialize ---
document.addEventListener('DOMContentLoaded', () => {
    createCheckboxes();
    createChart();
    setupRealtimeListeners();
    setInterval(updateSensorStatus, 10000);
});
</script>

</body>
</html>
