<!-- Firebase and Chart.js SDKs -->
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-database-compat.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<script>
  // Your Firebase config
  const firebaseConfig = {
    apiKey: "AIzaSyATktR2jpo9ghUY0_MqpZh_KP5jrW-6YZE",
    authDomain: "ultracoldmatterlablive.firebaseapp.com",
    databaseURL: "https://ultracoldmatterlablive-default-rtdb.asia-southeast1.firebasedatabase.app",
    projectId: "ultracoldmatterlablive",
    storageBucket: "ultracoldmatterlablive.firebasestorage.app",
    messagingSenderId: "75894080963",
    appId: "1:75894080963:web:cfa41a9bd08d4f567f6976"
  };

  // Initialize Firebase
  if (!firebase.apps.length) {
    firebase.initializeApp(firebaseConfig);
  }
  const database = firebase.database();

  // Chart.js setup
  const ctx = document.getElementById('sensorChart').getContext('2d');

  const sensorColors = [
    'rgb(255, 99, 132)',    // Sensor 1 - Red
    'rgb(54, 162, 235)',    // Sensor 2 - Blue
    'rgb(255, 206, 86)',    // Sensor 3 - Yellow
    'rgb(75, 192, 192)',    // Sensor 4 - Teal
    'rgb(153, 102, 255)',   // Sensor 5 - Purple
    'rgb(255, 159, 64)'     // Sensor 6 - Orange
  ];

  const chartData = {
    labels: [],
    datasets: []
  };

  for(let i=0; i<6; i++) {
    chartData.datasets.push({
      label: `Sensor ${i+1} Temp (°C)`,
      data: [],
      borderColor: sensorColors[i],
      fill: false,
      tension: 0.1,
      borderWidth: 2,
      spanGaps: true,
    });
    chartData.datasets.push({
      label: `Sensor ${i+1} Hum (%)`,
      data: [],
      borderColor: sensorColors[i],
      fill: false,
      borderDash: [5,5],
      borderWidth: 2,
      tension: 0.1,
      spanGaps: true,
    });
  }

  const sensorChart = new Chart(ctx, {
    type: 'line',
    data: chartData,
    options: {
      responsive: true,
      interaction: {
        mode: 'nearest',
        intersect: false
      },
      scales: {
        x: {
          type: 'time',
          time: {
            tooltipFormat: 'dd MMM yyyy HH:mm:ss',
            displayFormats: { second: 'HH:mm:ss' }
          },
          title: { display: true, text: 'Time' }
        },
        y: {
          beginAtZero: true,
          title: { display: true, text: 'Value' }
        }
      },
      plugins: {
        legend: { position: 'top' }
      }
    }
  });

  // Serial monitor
  const serialMonitor = document.getElementById('serialMonitor');
  const maxSerialEntries = 20;
  let serialEntries = [];

  function addSerialEntry(text) {
    serialEntries.unshift(text);
    if (serialEntries.length > maxSerialEntries) serialEntries.pop();
    serialMonitor.innerHTML = serialEntries.map(e => `<div>${e}</div>`).join('');
  }

  // Format ISO timestamp nicely
  function formatTimestamp(iso) {
    const d = new Date(iso);
    if (isNaN(d)) return iso;
    return d.toLocaleString('en-IN', {
      day: '2-digit', month: 'short', year: 'numeric',
      hour: '2-digit', minute: '2-digit', second: '2-digit',
      hour12: true
    });
  }

  // Firebase listener for all 6 sensors
  function setupFirebaseListeners() {
    for(let sensorNum = 1; sensorNum <= 6; sensorNum++) {
      const sensorPath = `/sensors/sensor${sensorNum}`;
      const sensorRef = database.ref(sensorPath);

      sensorRef.limitToLast(1).on('child_added', snapshot => {
        const timestamp = snapshot.key;
        const data = snapshot.val();

        if (!data) return;

        const timeFormatted = formatTimestamp(timestamp);
        const temp = data.temperature;
        const hum = data.humidity;

        const timeDate = new Date(timestamp);
        if (isNaN(timeDate)) return;

        const tempDatasetIndex = (sensorNum - 1) * 2;
        const humDatasetIndex = tempDatasetIndex + 1;

        chartData.datasets[tempDatasetIndex].data.push({ x: timeDate, y: temp });
        chartData.datasets[humDatasetIndex].data.push({ x: timeDate, y: hum });

        if (chartData.datasets[tempDatasetIndex].data.length > 50) {
          chartData.datasets[tempDatasetIndex].data.shift();
        }
        if (chartData.datasets[humDatasetIndex].data.length > 50) {
          chartData.datasets[humDatasetIndex].data.shift();
        }

        sensorChart.update('none');

        addSerialEntry(
          `Sensor ${sensorNum} | Temp: ${temp.toFixed(2)} °C, Hum: ${hum.toFixed(2)} % | ${timeFormatted}`
        );
      });
    }
  }

  setupFirebaseListeners();

</script>
