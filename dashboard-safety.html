<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Live Sensor Dashboard</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
  <style>
    body { font-family: Arial, sans-serif; padding: 10px; }
    canvas { max-width: 100%; }
    #status { margin-top: 10px; }
    .online { color: green; font-weight: bold; }
    .offline { color: red; }
  </style>
</head>
<body>
  <h2>UltraCold Lab - Live Safety Monitoring</h2>
  <canvas id="sensorChart" height="100"></canvas>
  <div id="status"></div>

  <script>
    // Firebase Config
    const firebaseConfig = {
      apiKey: "AIzaSyATktR2jpo9ghUY0_MqpZh_KP5jrW-6YZE",
      authDomain: "ultracoldmatterlablive.firebaseapp.com",
      databaseURL: "https://ultracoldmatterlablive-default-rtdb.asia-southeast1.firebasedatabase.app",
      projectId: "ultracoldmatterlablive",
    };

    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    // Chart Setup
    const ctx = document.getElementById("sensorChart").getContext("2d");
    const sensorColors = ['red', 'blue', 'green', 'orange', 'purple', 'brown'];

    const chart = new Chart(ctx, {
      type: 'line',
      data: {
        datasets: Array.from({ length: 6 }, (_, i) => ({
          label: `Sensor ${i + 1} Temp`,
          data: [],
          borderColor: sensorColors[i],
          backgroundColor: sensorColors[i],
          borderWidth: 2,
          tension: 0.3,
        }))
      },
      options: {
        responsive: true,
        scales: {
          x: {
            type: 'time',
            time: { unit: 'minute' },
            title: { display: true, text: 'Time' }
          },
          y: {
            title: { display: true, text: 'Temperature (°C)' }
          }
        }
      }
    });

    const statusDiv = document.getElementById("status");

    // Load latest values from each sensor
    function listenToSensor(i) {
      const sensorPath = `sensors/sensor${i + 1}`;
      db.ref(sensorPath).limitToLast(1).on("child_added", snapshot => {
        const timestamp = snapshot.key;
        const data = snapshot.val();
        if (!data.temperature) return;

        const time = new Date(timestamp);
        chart.data.datasets[i].data.push({ x: time, y: data.temperature });
        chart.update();

        // Show status
        document.getElementById(`sensor${i + 1}_status`)?.remove();
        const statusLine = document.createElement("div");
        statusLine.id = `sensor${i + 1}_status`;
        statusLine.innerHTML = `Sensor ${i + 1}: <span class="online">ONLINE</span> @ ${timestamp} | Temp: ${data.temperature} °C | Hum: ${data.humidity} %`;
        statusDiv.appendChild(statusLine);
      });
    }

    for (let i = 0; i < 6; i++) listenToSensor(i);
  </script>
</body>
</html>
