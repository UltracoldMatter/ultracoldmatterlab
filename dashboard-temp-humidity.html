<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Simple Thin Lines Dashboard</title>
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.2/dist/chart.umd.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-zoom@2.0.1/dist/chartjs-plugin-zoom.umd.min.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
<style>
  body {
    margin: 0; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    background: #f9f9f9; display: flex; flex-direction: column; min-height: 100vh;
  }
  .navbar {
    background: #fff; padding: 1rem 2rem; border-bottom: 2px solid #ccc;
    display: flex; justify-content: flex-end; align-items: center;
  }
  .nav-links a {
    color: #003366; text-decoration: none; margin-left: 1.5rem; font-weight: 600;
  }
  .nav-links a:hover { text-decoration: underline; }
  .lab-header {
    background: #004080; color: white; padding: 1.5rem; text-align: center;
    font-size: 1.8rem; font-weight: bold; border-top: 4px solid #002244; border-bottom: 4px solid #002244;
  }
  .sub-header {
    text-align: center; font-size: 0.9rem; color: #444; padding: 0.5rem 1rem;
  }
  .main-container {
    max-width: 1200px; margin: 1rem auto; padding: 0 1rem; display: flex; flex-direction: column; gap: 1.8rem;
  }
  .top-bar {
    display: flex; justify-content: flex-start; align-items: center; gap: 1rem; margin-bottom: 1rem;
  }
  select, button {
    padding: 0.4rem 0.8rem; font-size: 1rem;
  }
  .panel {
    background: white; border: 1px solid #ccc; border-radius: 8px; padding: 1rem;
    display: flex; flex-direction: column;
  }
  .panel h2 {
    color: #003366; margin-bottom: 0.8rem;
  }
  .checkbox-group {
    margin-bottom: 1rem;
  }
  .checkbox-group label {
    margin-right: 1rem; font-weight: 600; cursor: pointer; user-select: none;
  }
  .checkbox-group input[type="checkbox"] {
    accent-color: #003366; margin-right: 0.3em;
  }
  .chart-container {
    width: 100%; height: 500px; margin-bottom: 1rem;
  }
  canvas {
    width: 100% !important; height: 100% !important;
  }
  .serial-monitor {
    background: #000; color: #0f0; font-family: monospace;
    height: 140px; overflow-y: auto; padding: 0.5rem; border-radius: 6px;
    font-size: 1.05rem;
  }
  .footer {
    background: #003366; height: 60px; margin-top: auto;
  }
  @media (max-width: 900px) {
    .chart-container { height: 300px; }
  }
</style>
</head>
<body>

<div class="navbar">
  <div class="nav-links">
    <a href="index.html">Home</a>
    <a href="description.html">Description</a>
    <a href="dashboard-temp-humidity.html">Live Dashboard - Temperature & Humidity</a>
    <a href="dashboard-safety.html">Live Dashboard - Safety Monitoring</a>
  </div>
</div>

<div class="lab-header">ULTRACOLD MATTER LAB</div>
<div class="sub-header">Hemvati Nandan Bahuguna Garhwal University (A Central University), Srinagar, Uttarakhand, India (249161)</div>

<div class="main-container">

  <div class="top-bar">
    <label for="time-range">Time Range:</label>
    <select id="time-range">
      <option value="15">Past 15 Minutes</option>
      <option value="30">Past 30 Minutes</option>
      <option value="60" selected>Past 1 Hour</option>
      <option value="120">Past 2 Hours</option>
      <option value="360">Past 6 Hours</option>
      <option value="720">Past 12 Hours</option>
      <option value="1440">Past 1 Day</option>
      <option value="10080">Past 1 Week</option>
      <option value="43200">Past 1 Month</option>
    </select>
    <button id="resetZoomBtn">Reset Zoom</button>
  </div>

  <div class="panel">
    <h2>Temperature Panel</h2>
    <div class="checkbox-group" id="temp-checkboxes">
      <label style="color:#FF6384;"><input type="checkbox" value="sensor1" checked> Sensor 1</label>
      <label style="color:#36A2EB;"><input type="checkbox" value="sensor2" checked> Sensor 2</label>
      <label style="color:#FFCE56;"><input type="checkbox" value="sensor3" checked> Sensor 3</label>
      <label style="color:#4BC0C0;"><input type="checkbox" value="sensor4" checked> Sensor 4</label>
      <label style="color:#9966FF;"><input type="checkbox" value="sensor5" checked> Sensor 5</label>
      <label style="color:#FF9F40;"><input type="checkbox" value="sensor6" checked> Sensor 6</label>
    </div>
    <div class="chart-container">
      <canvas id="tempChart"></canvas>
    </div>
    <div class="serial-monitor" id="temp-serial">Serial Monitor: Temperature data streaming...</div>
  </div>

  <div class="panel">
    <h2>Humidity Panel</h2>
    <div class="checkbox-group" id="hum-checkboxes">
      <label style="color:#FF6384;"><input type="checkbox" value="sensor1" checked> Sensor 1</label>
      <label style="color:#36A2EB;"><input type="checkbox" value="sensor2" checked> Sensor 2</label>
      <label style="color:#FFCE56;"><input type="checkbox" value="sensor3" checked> Sensor 3</label>
      <label style="color:#4BC0C0;"><input type="checkbox" value="sensor4" checked> Sensor 4</label>
      <label style="color:#9966FF;"><input type="checkbox" value="sensor5" checked> Sensor 5</label>
      <label style="color:#FF9F40;"><input type="checkbox" value="sensor6" checked> Sensor 6</label>
    </div>
    <div class="chart-container">
      <canvas id="humChart"></canvas>
    </div>
    <div class="serial-monitor" id="hum-serial">Serial Monitor: Humidity data streaming...</div>
  </div>

</div>

<div class="footer"></div>

<script>
// Firebase config and init
const firebaseConfig = {
  apiKey: "AIzaSyATktR2jpo9ghUY0_MqpZh_KP5jrW-6YZE",
  authDomain: "ultracoldmatterlablive.firebaseapp.com",
  databaseURL: "https://ultracoldmatterlablive-default-rtdb.asia-southeast1.firebasedatabase.app",
  projectId: "ultracoldmatterlablive",
  storageBucket: "ultracoldmatterlablive.appspot.com",
  messagingSenderId: "75894080963",
  appId: "1:75894080963:web:cfa41a9bd08d4f567f6976"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.database();

const sensorIds = ['sensor1','sensor2','sensor3','sensor4','sensor5','sensor6'];
const sensorColors = [
  'rgba(255,99,132,1)',
  'rgba(54,162,235,1)',
  'rgba(255,206,86,1)',
  'rgba(75,192,192,1)',
  'rgba(153,102,255,1)',
  'rgba(255,159,64,1)'
];

let allData = {};

const tempCtx = document.getElementById('tempChart').getContext('2d');
const humCtx = document.getElementById('humChart').getContext('2d');
let tempChart, humChart;

function mixWhite(color, percent) {
  const match = color.match(/rgba?\((\d+),\s*(\d+),\s*(\d+)/);
  if (!match) return color;
  const r = Math.round((1 - percent) * parseInt(match[1]) + percent * 255);
  const g = Math.round((1 - percent) * parseInt(match[2]) + percent * 255);
  const b = Math.round((1 - percent) * parseInt(match[3]) + percent * 255);
  return `rgba(${r},${g},${b},0.7)`;
}

function prepareTempChartData() {
  const selected = Array.from(document.querySelectorAll('#temp-checkboxes input[type=checkbox]'))
    .filter(cb => cb.checked)
    .map((cb, idx) => sensorIds[idx]);
  const now = new Date();
  const rangeMinutes = parseInt(document.getElementById('time-range').value);
  const minTime = new Date(now.getTime() - rangeMinutes*60000);
  const datasets = [];
  selected.forEach(sensorId => {
    const colorIdx = sensorIds.indexOf(sensorId);
    const data = [];
    if(allData[sensorId]) {
      Object.entries(allData[sensorId]).forEach(([timestamp, values]) => {
        const dt = new Date(timestamp);
        if(!isNaN(dt) && dt >= minTime && dt <= now && typeof values.temperature === 'number') {
          data.push({x: dt, y: values.temperature});
        }
      });
    }
    datasets.push({
      label: `Sensor ${colorIdx+1}`,
      data,
      borderColor: sensorColors[colorIdx],
      backgroundColor: sensorColors[colorIdx].replace('1)', '0.15)'),
      borderWidth: 1.5,
      fill: false,
      tension: 0,
      pointRadius: 0,
      borderDash: []
    });
  });
  return datasets;
}

function prepareHumChartData() {
  const selected = Array.from(document.querySelectorAll('#hum-checkboxes input[type=checkbox]'))
    .filter(cb => cb.checked)
    .map((cb, idx) => sensorIds[idx]);
  const now = new Date();
  const rangeMinutes = parseInt(document.getElementById('time-range').value);
  const minTime = new Date(now.getTime() - rangeMinutes*60000);
  const datasets = [];
  selected.forEach(sensorId => {
    const colorIdx = sensorIds.indexOf(sensorId);
    const data = [];
    if(allData[sensorId]) {
      Object.entries(allData[sensorId]).forEach(([timestamp, values]) => {
        const dt = new Date(timestamp);
        if(!isNaN(dt) && dt >= minTime && dt <= now && typeof values.humidity === 'number') {
          data.push({x: dt, y: values.humidity});
        }
      });
    }
    datasets.push({
      label: `Sensor ${colorIdx+1}`,
      data,
      borderColor: mixWhite(sensorColors[colorIdx], 0.5),
      backgroundColor: 'rgba(255,255,255,0.1)',
      borderWidth: 1.5,
      fill: false,
      tension: 0,
      pointRadius: 0,
      borderDash: [4,4]
    });
  });
  return datasets;
}

function updateTempSerial() {
  const selected = Array.from(document.querySelectorAll('#temp-checkboxes input[type=checkbox]'))
    .filter(cb => cb.checked)
    .map((cb, idx) => sensorIds[idx]);
  const now = new Date();
  const rangeMinutes = parseInt(document.getElementById('time-range').value);
  const minTime = new Date(now.getTime() - rangeMinutes*60000);
  let entries = [];
  selected.forEach(sensorId => {
    if(allData[sensorId]) {
      Object.entries(allData[sensorId]).forEach(([timestamp, values]) => {
        const dt = new Date(timestamp);
        if(!isNaN(dt) && dt >= minTime && dt <= now && typeof values.temperature === 'number') {
          entries.push({sensorId, timestamp, temp: values.temperature});
        }
      });
    }
  });
  entries.sort((a,b) => b.timestamp.localeCompare(a.timestamp));
  document.getElementById('temp-serial').innerHTML = entries.slice(0,40).map(e =>
    `Sensor ${sensorIds.indexOf(e.sensorId)+1} → Temp: ${e.temp.toFixed(2)} °C at ${e.timestamp}`
  ).map(e => `<div>${e}</div>`).join('');
}

function updateHumSerial() {
  const selected = Array.from(document.querySelectorAll('#hum-checkboxes input[type=checkbox]'))
    .filter(cb => cb.checked)
    .map((cb, idx) => sensorIds[idx]);
  const now = new Date();
  const rangeMinutes = parseInt(document.getElementById('time-range').value);
  const minTime = new Date(now.getTime() - rangeMinutes*60000);
  let entries = [];
  selected.forEach(sensorId => {
    if(allData[sensorId]) {
      Object.entries(allData[sensorId]).forEach(([timestamp, values]) => {
        const dt = new Date(timestamp);
        if(!isNaN(dt) && dt >= minTime && dt <= now && typeof values.humidity === 'number') {
          entries.push({sensorId, timestamp, hum: values.humidity});
        }
      });
    }
  });
  entries.sort((a,b) => b.timestamp.localeCompare(a.timestamp));
  document.getElementById('hum-serial').innerHTML = entries.slice(0,40).map(e =>
    `Sensor ${sensorIds.indexOf(e.sensorId)+1} → Hum: ${e.hum.toFixed(2)} % at ${e.timestamp}`
  ).map(e => `<div>${e}</div>`).join('');
}

sensorIds.forEach(sensorId => {
  allData[sensorId] = {};
  const sensorRef = db.ref('sensors/' + sensorId);
  sensorRef.limitToLast(1000).on('value', snapshot => {
    const data = snapshot.val();
    allData[sensorId] = data || {};
    if(tempChart) tempChart.destroy();
    tempChart = buildChart(tempCtx, prepareTempChartData(), true);
    if(humChart) humChart.destroy();
    humChart = buildChart(humCtx, prepareHumChartData(), false);
    updateTempSerial();
    updateHumSerial();
  });
});

Array.from(document.querySelectorAll('#temp-checkboxes input[type=checkbox],#hum-checkboxes input[type=checkbox]')).forEach(cb => {
  cb.addEventListener('change', () => {
    if(tempChart) tempChart.destroy();
    tempChart = buildChart(tempCtx, prepareTempChartData(), true);
    updateTempSerial();
    if(humChart) humChart.destroy();
    humChart = buildChart(humCtx, prepareHumChartData(), false);
    updateHumSerial();
  });
});

document.getElementById('time-range').addEventListener('change', () => {
  if(tempChart) tempChart.destroy();
  tempChart = buildChart(tempCtx, prepareTempChartData(), true);
  updateTempSerial();
  if(humChart) humChart.destroy();
  humChart = buildChart(humCtx, prepareHumChartData(), false);
  updateHumSerial();
});

document.getElementById('resetZoomBtn').addEventListener('click', () => {
  if(tempChart) tempChart.resetZoom();
  if(humChart) humChart.resetZoom();
});
</script>
</body>
</html>
